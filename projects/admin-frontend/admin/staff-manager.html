<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Staff | Animora Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../styles/main.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      <link rel="stylesheet" href="../styles/main.css">

    <div class="staff-grid" id="staffGrid">
      <!-- Staff cards will be loaded here -->
    </div>
  </div>

  <!-- Modal for Add/Edit -->
  <div class="modal" id="staffModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Team Member</h2>
        <button class="close-btn" onclick="closeModal()">Ã—</button>
      </div>
      <form id="staffForm">
        <input type="hidden" id="staffId">
        
        <div class="form-group">
          <label for="staffName">Full Name *</label>
          <input type="text" id="staffName" required>
        </div>

        <div class="form-group">
          <label for="staffTitle">Title/Position *</label>
          <input type="text" id="staffTitle" required>
        </div>

        <div class="form-group">
          <label>Staff Photo *</label>
          <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" class="file-input" accept="image/*">
            <div id="uploadPlaceholder">
              <div class="upload-icon">ðŸ“¸</div>
              <p class="upload-text"><strong>Click to upload</strong> or drag and drop</p>
              <p class="upload-text" style="font-size: 0.9rem;">JPG, PNG or GIF (max 5MB)</p>
            </div>
            <img id="imagePreview" class="image-preview" style="display: none;">
            <button type="button" class="change-photo-btn" id="changePhotoBtn" style="display: none;">Change Photo</button>
          </div>
          <input type="hidden" id="staffImage" required>
        </div>

        <div class="form-group">
          <label for="staffBio">Bio/Description</label>
          <textarea id="staffBio" placeholder="Brief description of the team member..."></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Save Member</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let staffData = [];
    let editingId = null;
    let uploadedImagePath = null;

    // Load staff data
    async function loadStaff() {
      try {
        const response = await fetch('/api/resources?type=staff');
        staffData = await response.json();
        renderStaff();
      } catch (error) {
        showAlert('Error loading staff data', 'error');
      }
    }

    // Render staff cards
    function renderStaff() {
      const grid = document.getElementById('staffGrid');
      if (!staffData || staffData.length === 0) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #6b7280;">No team members yet. Add your first member!</p>';
        return;
      }
      grid.innerHTML = staffData.map(member => `
        <div class="staff-card">
          <img src="../${member.image}" alt="${member.name}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
          <h3>${member.name}</h3>
          <p><strong>${member.title}</strong></p>
          ${member.bio ? `<p style="font-size: 0.9rem;">${member.bio}</p>` : ''}
          <div class="card-actions">
            <button class="btn btn-primary" onclick="editStaff('${member._id}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteStaff('${member._id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Open modal
    function openModal(id = null) {
      editingId = id;
      uploadedImagePath = null;
      const modal = document.getElementById('staffModal');
      const form = document.getElementById('staffForm');
      const title = document.getElementById('modalTitle');

      form.reset();
      resetImageUpload();

      if (id) {
        title.textContent = 'Edit Team Member';
        const member = staffData.find(s => s._id === id);
        if (member) {
          document.getElementById('staffId').value = member._id;
          document.getElementById('staffName').value = member.name;
          document.getElementById('staffTitle').value = member.title;
          document.getElementById('staffImage').value = member.image;
          document.getElementById('staffBio').value = member.bio || '';
          // Show existing image
          if (member.image) {
            showImagePreview('../' + member.image);
            uploadedImagePath = member.image;
          }
        }
      } else {
        title.textContent = 'Add Team Member';
      }
      modal.classList.add('active');
    }

    // Close modal
    function closeModal() {
      document.getElementById('staffModal').classList.remove('active');
      editingId = null;
    }

    // Edit staff
    function editStaff(id) {
      openModal(id);
    }

    // Delete staff
    async function deleteStaff(id) {
      if (!confirm('Are you sure you want to delete this team member?')) return;
      try {
        const response = await fetch(`/api/resources?type=staff&id=${id}`, {
          method: 'DELETE'
        });
        if (!response.ok) throw new Error('Delete failed');
        staffData = staffData.filter(s => s._id !== id);
        renderStaff();
        showAlert('Team member deleted successfully', 'success');
      } catch (error) {
        showAlert('Error deleting team member', 'error');
      }
    }

    // Image upload handling
    function resetImageUpload() {
      document.getElementById('uploadPlaceholder').style.display = 'block';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('changePhotoBtn').style.display = 'none';
      document.getElementById('fileInput').value = '';
      document.getElementById('staffImage').value = '';
    }

    function showImagePreview(src) {
      document.getElementById('uploadPlaceholder').style.display = 'none';
      document.getElementById('imagePreview').src = src;
      document.getElementById('imagePreview').style.display = 'block';
      document.getElementById('changePhotoBtn').style.display = 'inline-block';
    }

    // Handle file selection
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file
      if (!file.type.startsWith('image/')) {
        showAlert('Please select an image file', 'error');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        showAlert('Image size must be less than 5MB', 'error');
        return;
      }

      // Show preview and upload
      const reader = new FileReader();
      reader.onload = async (event) => {
        showImagePreview(event.target.result);
        
        // Upload to server
        try {
          const response = await fetch('/api/upload-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: event.target.result })
          });

          const result = await response.json();
          if (result.success) {
            uploadedImagePath = result.imagePath;
            document.getElementById('staffImage').value = result.imagePath;
            showAlert('Image uploaded successfully', 'success');
          } else {
            throw new Error('Upload failed');
          }
        } catch (error) {
          showAlert('Error uploading image', 'error');
          resetImageUpload();
        }
      };
      reader.readAsDataURL(file);
    });

    // Change photo button
    document.getElementById('changePhotoBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('fileInput').click();
    });

    // Drag and drop
    const uploadArea = document.getElementById('imageUploadArea');
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const file = e.dataTransfer.files[0];
      if (file) {
        const input = document.getElementById('fileInput');
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        input.files = dataTransfer.files;
        input.dispatchEvent(new Event('change'));
      }
    });

    // Handle form submit
    document.getElementById('staffForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const imageValue = document.getElementById('staffImage').value;
      if (!imageValue) {
        showAlert('Please upload a photo', 'error');
        return;
      }
      const member = {
        name: document.getElementById('staffName').value,
        title: document.getElementById('staffTitle').value,
        image: imageValue,
        bio: document.getElementById('staffBio').value
      };
      try {
        if (editingId) {
          // Update
          const response = await fetch('/api/resources?type=staff', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ _id: editingId, ...member })
          });
          if (!response.ok) throw new Error('Update failed');
          // Update local data
          const updated = await response.json();
          const idx = staffData.findIndex(s => s._id === editingId);
          if (idx !== -1) staffData[idx] = { _id: editingId, ...member };
        } else {
          // Create
          const response = await fetch('/api/resources?type=staff', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(member)
          });
          if (!response.ok) throw new Error('Create failed');
          const created = await response.json();
          staffData.push({ _id: created.id, ...member });
        }
        closeModal();
        renderStaff();
        showAlert('Team member saved successfully', 'success');
      } catch (error) {
        showAlert('Error saving team member', 'error');
      }
    });

    // No longer needed: saveStaff function (all CRUD is now RESTful)

    // Show alert
    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);

      setTimeout(() => alert.remove(), 3000);
    }

    // Close modal on outside click
    document.getElementById('staffModal').addEventListener('click', (e) => {
      if (e.target.id === 'staffModal') closeModal();
    });

    // Initialize
    loadStaff();
  </script>
<body class="admin-bg">
  <div class="container admin">
    <div class="header admin">
              <p class="upload-text" style="font-size: 0.9rem;">JPG, PNG or GIF (max 5MB)</p>
