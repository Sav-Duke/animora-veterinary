<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Security Scanner | Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="site-health.html">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f3f4f6; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .header h1 { color: #dc2626; display: flex; align-items: center; gap: 12px; }
    .back-btn { background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; transition: all 0.2s; }
    .back-btn:hover { background: #4b5563; }
    .security-score { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 40px; border-radius: 12px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3); }
    .security-score h2 { font-size: 3.5rem; margin-bottom: 10px; }
    .security-score p { font-size: 1.2rem; opacity: 0.9; }
    .threats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .threat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid; }
    .threat-card.critical { border-color: #dc2626; }
    .threat-card.high { border-color: #f59e0b; }
    .threat-card.medium { border-color: #3b82f6; }
    .threat-card.low { border-color: #10b981; }
    .threat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .threat-header h3 { color: #374151; display: flex; align-items: center; gap: 10px; }
    .severity-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
    .severity-badge.critical { background: #fee2e2; color: #991b1b; }
    .severity-badge.high { background: #fef3c7; color: #92400e; }
    .severity-badge.medium { background: #dbeafe; color: #1e40af; }
    .severity-badge.low { background: #d1fae5; color: #065f46; }
    .threat-description { color: #6b7280; margin-bottom: 15px; line-height: 1.6; }
    .threat-actions { display: flex; gap: 10px; }
    .action-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
    .fix-btn { background: #16A34A; color: white; }
    .fix-btn:hover { background: #15803d; }
    .info-btn { background: #3b82f6; color: white; }
    .info-btn:hover { background: #2563eb; }
    .scan-btn { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1rem; font-weight: 600; width: 100%; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3); transition: all 0.3s; margin-bottom: 20px; }
    .scan-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4); }
    .recommendations { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .recommendations h3 { color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .recommendation-item { padding: 15px; margin-bottom: 10px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #16A34A; }
    .recommendation-item h4 { color: #374151; margin-bottom: 5px; }
    .recommendation-item p { color: #6b7280; font-size: 0.9rem; }
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat-box { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .stat-box h4 { color: #6b7280; font-size: 0.9rem; margin-bottom: 10px; }
    .stat-box .value { font-size: 2rem; font-weight: 700; color: #374151; }
    .stat-box .value.good { color: #16A34A; }
    .stat-box .value.bad { color: #dc2626; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><span>üîí</span>Security Scanner</h1>
      <a href="index.html" class="back-btn">‚Üê Back to Admin</a>
    </div>

    <div class="security-score">
      <h2 id="securityScore">--</h2>
      <p id="securityLabel">Click "Scan for Threats" to analyze security</p>
    </div>

    <button class="scan-btn" onclick="runSecurityScan()">üîç Scan for Security Threats</button>

    <div class="stats-row" id="statsRow" style="display: none;">
      <div class="stat-box">
        <h4>Threats Found</h4>
        <div class="value bad" id="threatsCount">0</div>
      </div>
      <div class="stat-box">
        <h4>Critical Issues</h4>
        <div class="value bad" id="criticalCount">0</div>
      </div>
      <div class="stat-box">
        <h4>Protected Areas</h4>
        <div class="value good" id="protectedCount">0</div>
      </div>
      <div class="stat-box">
        <h4>Last Scan</h4>
        <div class="value" style="font-size: 1rem;" id="lastScan">Never</div>
      </div>
    </div>

    <div class="threats-grid" id="threatsGrid"></div>

    <div class="recommendations" id="recommendations" style="display: none;">
      <h3><span>üí°</span>Security Recommendations</h3>
      <div id="recommendationsList"></div>
    </div>
  </div>

  <script>
    const securityChecks = [
      {
        id: 'sql_injection',
        title: 'SQL Injection Protection',
        description: 'Checking if database queries are protected against SQL injection attacks',
        severity: 'critical',
        check: () => true, // Using JSON files, no SQL database
        fix: 'Using JSON file storage - No SQL injection risk'
      },
      {
        id: 'xss',
        title: 'Cross-Site Scripting (XSS)',
        description: 'Checking if user inputs are properly sanitized',
        severity: 'high',
        check: () => {
          return document.querySelectorAll('input[type="text"]').length > 0;
        },
        fix: 'Add input sanitization and validation on all forms'
      },
      {
        id: 'csrf',
        title: 'CSRF Token Protection',
        description: 'Checking for Cross-Site Request Forgery protection',
        severity: 'high',
        check: () => false,
        fix: 'Implement CSRF tokens for form submissions'
      },
      {
        id: 'https',
        title: 'HTTPS Encryption',
        description: 'Checking if site uses secure HTTPS protocol',
        severity: 'critical',
        check: () => window.location.protocol === 'https:',
        fix: 'Install SSL certificate and enforce HTTPS'
      },
      {
        id: 'headers',
        title: 'Security Headers',
        description: 'Checking for proper security headers (CSP, X-Frame-Options, etc.)',
        severity: 'medium',
        check: () => false,
        fix: 'Add security headers in server configuration'
      },
      {
        id: 'auth',
        title: 'Authentication Security',
        description: 'Checking password storage and authentication mechanisms',
        severity: 'critical',
        check: () => localStorage.getItem('animoraAdminPasswordHash') !== null,
        fix: 'Implement secure password hashing (bcrypt/argon2)'
      },
      {
        id: 'file_upload',
        title: 'File Upload Security',
        description: 'Checking file upload validation and restrictions',
        severity: 'high',
        check: () => true, // Has file size limits
        fix: 'Validate file types, scan for malware, limit file sizes'
      },
      {
        id: 'api_security',
        title: 'API Endpoint Security',
        description: 'Checking if API endpoints have proper authentication',
        severity: 'high',
        check: () => false,
        fix: 'Add API authentication tokens and rate limiting'
      },
      {
        id: 'cors',
        title: 'CORS Configuration',
        description: 'Checking Cross-Origin Resource Sharing settings',
        severity: 'medium',
        check: () => true,
        fix: 'Configure CORS to allow only trusted domains'
      },
      {
        id: 'dependencies',
        title: 'Vulnerable Dependencies',
        description: 'Checking for outdated or vulnerable packages',
        severity: 'medium',
        check: () => true,
        fix: 'Run npm audit and update vulnerable packages'
      }
    ];

    async function runSecurityScan() {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Scanning for threats...';

      const threats = [];
      const protectedArr = [];
      let criticalCount = 0;

      securityChecks.forEach(check => {
        const isSecure = check.check();
        if (!isSecure) {
          threats.push(check);
          if (check.severity === 'critical') criticalCount++;
        } else {
          protectedArr.push(check);
        }
      });

      // Calculate security score
      const secureCount = protectedArr.length;
      const totalChecks = securityChecks.length;
      const score = Math.round((secureCount / totalChecks) * 100);
      const lastScan = new Date().toLocaleTimeString();

      // Save results to backend
      try {
        await fetch('/api/security', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lastScan,
            score,
            threats,
            protected: protectedArr,
            criticalCount
          })
        });
      } catch (e) {
        // ignore
      }

      // Update UI
      updateSecurityUI({ lastScan, score, threats, protected: protectedArr, criticalCount });

      btn.disabled = false;
      btn.innerHTML = 'üîç Scan for Security Threats';
    }

    async function loadSecurityScan() {
      try {
        const res = await fetch('/api/security');
        if (!res.ok) throw new Error('No scan data');
        const data = await res.json();
        if (data && data.score !== null) {
          updateSecurityUI(data);
        }
      } catch (e) {
        // ignore
      }
    }

    function updateSecurityUI({ lastScan, score, threats, protected: protectedArr, criticalCount }) {
      document.getElementById('securityScore').textContent = (score !== null ? score + '/100' : '--');
      document.getElementById('threatsCount').textContent = threats.length;
      document.getElementById('criticalCount').textContent = criticalCount;
      document.getElementById('protectedCount').textContent = protectedArr.length;
      document.getElementById('lastScan').textContent = lastScan || 'Never';

      const scoreElement = document.querySelector('.security-score');
      const labelElement = document.getElementById('securityLabel');

      if (score >= 80) {
        labelElement.textContent = '‚úÖ Good Security - Minor improvements needed';
        scoreElement.style.background = 'linear-gradient(135deg, #16A34A 0%, #15803d 100%)';
      } else if (score >= 60) {
        labelElement.textContent = '‚ö†Ô∏è Moderate Security - Several issues found';
        scoreElement.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
      } else {
        labelElement.textContent = '‚ùå Poor Security - Critical vulnerabilities detected';
        scoreElement.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
      }

      displayThreats(threats);
      displayRecommendations(score);
      document.getElementById('statsRow').style.display = 'grid';
    }

    function displayThreats(threats) {
      const grid = document.getElementById('threatsGrid');
      grid.innerHTML = '';

      if (threats.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; background: white; border-radius: 12px;"><h3 style="color: #16A34A;">‚úÖ No Threats Detected!</h3><p style="color: #6b7280; margin-top: 10px;">Your site is secure with current configurations.</p></div>';
        return;
      }

      threats.forEach(threat => {
        const card = document.createElement('div');
        card.className = `threat-card ${threat.severity}`;
        card.innerHTML = `
          <div class="threat-header">
            <h3>${getSeverityIcon(threat.severity)} ${threat.title}</h3>
            <span class="severity-badge ${threat.severity}">${threat.severity.toUpperCase()}</span>
          </div>
          <div class="threat-description">${threat.description}</div>
          <div class="threat-actions">
            <button class="action-btn fix-btn" onclick="showFix('${threat.fix}')">üí° Fix</button>
            <button class="action-btn info-btn" onclick="showInfo('${threat.title}', '${threat.description}')">‚ÑπÔ∏è Details</button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function displayRecommendations(score) {
      const container = document.getElementById('recommendationsList');
      const recommendationsDiv = document.getElementById('recommendations');
      container.innerHTML = '';

      const recommendations = [
        {
          title: 'Implement HTTPS for Production',
          description: 'Use SSL/TLS certificate from Let\'s Encrypt or your hosting provider. This encrypts data in transit and boosts SEO rankings.'
        },
        {
          title: 'Add Rate Limiting to APIs',
          description: 'Protect against DDoS attacks by limiting requests per IP address. Use express-rate-limit package.'
        },
        {
          title: 'Enable Content Security Policy (CSP)',
          description: 'Add CSP headers to prevent XSS attacks and unauthorized script execution.'
        },
        {
          title: 'Implement API Authentication',
          description: 'Use JWT tokens or API keys to protect sensitive endpoints from unauthorized access.'
        },
        {
          title: 'Regular Security Audits',
          description: 'Run npm audit regularly and keep all dependencies updated to patch known vulnerabilities.'
        },
        {
          title: 'Input Validation & Sanitization',
          description: 'Validate and sanitize all user inputs on both client and server side to prevent injection attacks.'
        },
        {
          title: 'Backup Strategy',
          description: 'Implement automated daily backups of database and uploaded files to prevent data loss.'
        }
      ];

      recommendations.forEach(rec => {
        const item = document.createElement('div');
        item.className = 'recommendation-item';
        item.innerHTML = `
          <h4>‚úÖ ${rec.title}</h4>
          <p>${rec.description}</p>
        `;
        container.appendChild(item);
      });

      recommendationsDiv.style.display = 'block';
    }

    function getSeverityIcon(severity) {
      const icons = {
        critical: 'üî¥',
        high: 'üü†',
        medium: 'üü°',
        low: 'üü¢'
      };
      return icons[severity] || '‚ö™';
    }

    function showFix(fix) {
      alert(`Fix Suggestion:\n\n${fix}`);
    }

    function showInfo(title, description) {
      alert(`${title}\n\n${description}\n\nThis security check helps protect your site from potential vulnerabilities and attacks.`);
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      setTimeout(loadSecurityScan, 500);
    });
  </script>
</body>
</html>
