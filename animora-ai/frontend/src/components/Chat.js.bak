import React, { useState, useRef, useEffect } from 'react';
import axios from 'axios';
import ReactMarkdown from 'react-markdown';
import ImageUpload from './ImageUpload';

const API_BASE = 'http://localhost:4001/api';

export default function Chat() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [sessionId, setSessionId] = useState(`session_${Date.now()}`);
  const [conversationHistory, setConversationHistory] = useState([]);
  const [showImageUpload, setShowImageUpload] = useState(false);
  const [selectedSpecies, setSelectedSpecies] = useState('cattle');
  const [abortController, setAbortController] = useState(null);
  const messagesEndRef = useRef(null);

  // Auto-scroll to bottom when new messages arrive
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const stopGeneration = () => {
    if (abortController) {
      abortController.abort();
      setAbortController(null);
      setLoading(false);
      
      // Add stopped message
      setMessages((prev) => [
        ...prev.slice(0, -1), // Remove loading message if any
        { role: 'ai', content: 'âš ï¸ Response generation stopped by user.' }
      ]);
    }
  };

  const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text).then(() => {
      // Could add a toast notification here
    });
  };

  const handleSend = async () => {
    if (!input.trim() || loading) return;

    const userMsg = { role: 'user', content: input };
    setMessages((prev) => [...prev, userMsg]);
    const currentInput = input;
    setInput('');
    setLoading(true);

    // Create abort controller for this request
    const controller = new AbortController();
    setAbortController(controller);

    try {
      console.log('Sending to:', `${API_BASE}/chat`, 'Message:', currentInput);
      const res = await axios.post(`${API_BASE}/chat`, { 
        message: currentInput,
        sessionId: sessionId,
        conversationHistory: conversationHistory,
        useAI: true
      }, {
        signal: controller.signal,
        timeout: 60000 // 60 second timeout
      });
      
      const botMsg = { 
        role: 'ai', 
        content: res.data.reply,
        webSearchUsed: res.data.webSearchUsed || false,
        diseaseFound: res.data.diseaseFound || false
      };
      setMessages((prev) => [...prev, botMsg]);
      
      // Update conversation history from server
      if (res.data.conversationHistory) {
        setConversationHistory(res.data.conversationHistory);
      } else {
        setConversationHistory(prev => [
          ...prev,
          { role: 'user', content: currentInput },
          { role: 'assistant', content: res.data.reply }
        ].slice(-10));
      }
      
      if (res.data.sessionId) {
        setSessionId(res.data.sessionId);
      }
    } catch (err) {
      if (axios.isCancel(err) || err.name === 'CanceledError') {
        console.log('Request cancelled by user');
        return;
      }
      
      console.error('Chat error:', err);
      const errorMsg = `âŒ Error connecting to server. ${err.message}`;
      const botMsg = { role: 'ai', content: errorMsg };
      setMessages((prev) => [...prev, botMsg]);
    } finally {
      setLoading(false);
      setAbortController(null);
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const clearChat = () => {
    setMessages([]);
    setConversationHistory([]);
    setSessionId(`session_${Date.now()}`);
  };

  const handleImageAnalysis = (analysisResult) => {
    const aiMsg = {
      role: 'ai',
      content: analysisResult.response,
      imageAnalysis: analysisResult.imageAnalysis,
      alert: analysisResult.alert
    };
    setMessages(prev => [...prev, aiMsg]);
    
    setConversationHistory(prev => [
      ...prev,
      { role: 'user', content: '[Image uploaded for analysis]' },
      { role: 'assistant', content: analysisResult.response }
    ].slice(-10));
  };

  return (
    <div style={{ marginTop: '20px', maxWidth: '900px', margin: '20px auto' }}>
      {/* Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px', flexWrap: 'wrap', gap: '10px' }}>
        <h2 style={{ margin: 0 }}>ğŸ¾ Animora AI Chat</h2>
        <div style={{ display: 'flex', gap: '10px' }}>
          <button
            onClick={() => setShowImageUpload(!showImageUpload)}
            style={{
              padding: '5px 15px',
              backgroundColor: showImageUpload ? '#4CAF50' : '#2196F3',
              color: 'white',
              border: 'none',
              borderRadius: '5px',
              cursor: 'pointer',
              fontWeight: 'bold'
            }}
          >
            {showImageUpload ? 'ğŸ’¬ Text Chat' : 'ğŸ“¸ Image Diagnosis'}
          </button>
          <button
            onClick={clearChat}
            style={{
              padding: '5px 15px',
              backgroundColor: '#f0f0f0',
              border: '1px solid #ccc',
              borderRadius: '5px',
              cursor: 'pointer'
            }}
          >
            Clear Chat
          </button>
        </div>
      </div>

      {/* Species Selector */}
      <div style={{ marginBottom: '15px' }}>
        <label style={{ fontSize: '14px', marginRight: '10px' }}>Animal Species:</label>
        <select
          value={selectedSpecies}
          onChange={(e) => setSelectedSpecies(e.target.value)}
          style={{
            padding: '8px',
            borderRadius: '5px',
            border: '1px solid #ccc',
            fontSize: '14px'
          }}
        >
          <option value="cattle">ğŸ„ Cattle</option>
          <option value="goat">ğŸ Goat</option>
          <option value="sheep">ğŸ‘ Sheep</option>
          <option value="poultry">ğŸ” Poultry</option>
          <option value="pig">ğŸ· Pig</option>
          <option value="dog">ğŸ• Dog</option>
          <option value="cat">ğŸˆ Cat</option>
        </select>
      </div>

      {/* Image Upload Component */}
      {showImageUpload && (
        <ImageUpload
          onAnalysisComplete={handleImageAnalysis}
          species={selectedSpecies}
        />
      )}

      {/* Chat Window */}
      <div
        style={{
          border: '1px solid #ccc',
          borderRadius: '10px',
          padding: '15px',
          height: '500px',
          overflowY: 'auto',
          backgroundColor: '#f9f9f9',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}
      >
        {messages.length === 0 && (
          <div style={{ 
            textAlign: 'center', 
            color: '#888', 
            marginTop: '100px',
            fontSize: '16px'
          }}>
            <p>ğŸ‘‹ Welcome to Animora AI!</p>
            <p style={{ fontSize: '14px' }}>Ask me anything about animal diseases, symptoms, treatments, and veterinary care.</p>
            <p style={{ fontSize: '13px', marginTop: '20px' }}>Try questions like:</p>
            <ul style={{ listStyle: 'none', padding: 0, fontSize: '13px', color: '#666' }}>
              <li>â€¢ "Tell me about bovine mastitis"</li>
              <li>â€¢ "What are the symptoms of mastitis in dairy cows?"</li>
              <li>â€¢ "How do you treat mastitis?"</li>
            </ul>
          </div>
        )}
        
        {messages.map((msg, idx) => (
          <div
            key={idx}
            style={{
              display: 'flex',
              justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start',
              margin: '10px 0',
            }}
          >
            <div
              style={{
                maxWidth: '75%',
                padding: '10px 15px',
                borderRadius: '12px',
                backgroundColor: msg.role === 'user' ? '#dcf8c6' : '#fff',
                border: msg.role === 'ai' ? '1px solid #e0e0e0' : 'none',
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                wordWrap: 'break-word',
                position: 'relative'
              }}
            >
              {msg.role === 'ai' && (msg.webSearchUsed || msg.diseaseFound) && (
                <div style={{
                  display: 'flex',
                  gap: '8px',
                  marginBottom: '8px',
                  fontSize: '0.75em',
                  color: '#666',
                  flexWrap: 'wrap'
                }}>
                  {msg.diseaseFound && (
                    <span style={{
                      backgroundColor: '#e3f2fd',
                      padding: '2px 8px',
                      borderRadius: '10px',
                      border: '1px solid #2196f3'
                    }}>
                      ğŸ“š Database Match
                    </span>
                  )}
                  {msg.webSearchUsed && (
                    <span style={{
                      backgroundColor: '#fff3e0',
                      padding: '2px 8px',
                      borderRadius: '10px',
                      border: '1px solid #ff9800'
                    }}>
                      ğŸŒ Web Search
                    </span>
                  )}
                </div>
              )}
              
              {msg.role === 'ai' ? (
                <>
                  <ReactMarkdown
                    components={{
                      p: ({node, ...props}) => <p style={{margin: '8px 0'}} {...props} />,
                      ul: ({node, ...props}) => <ul style={{margin: '8px 0', paddingLeft: '20px'}} {...props} />,
                      ol: ({node, ...props}) => <ol style={{margin: '8px 0', paddingLeft: '20px'}} {...props} />,
                      li: ({node, ...props}) => <li style={{margin: '4px 0'}} {...props} />,
                      h1: ({node, ...props}) => <h1 style={{fontSize: '1.5em', margin: '10px 0'}} {...props} />,
                      h2: ({node, ...props}) => <h2 style={{fontSize: '1.3em', margin: '10px 0'}} {...props} />,
                      h3: ({node, ...props}) => <h3 style={{fontSize: '1.1em', margin: '8px 0'}} {...props} />,
                      strong: ({node, ...props}) => <strong style={{fontWeight: 'bold'}} {...props} />,
                      code: ({node, inline, ...props}) => 
                        inline ? 
                          <code style={{backgroundColor: '#f0f0f0', padding: '2px 4px', borderRadius: '3px', fontSize: '0.9em'}} {...props} /> :
                          <code style={{display: 'block', backgroundColor: '#f0f0f0', padding: '10px', borderRadius: '5px', fontSize: '0.9em', overflowX: 'auto'}} {...props} />
                    }}
                  >
                    {msg.content}
                  </ReactMarkdown>
                  <button
                    onClick={() => copyToClipboard(msg.content)}
                    title="Copy to clipboard"
                    style={{
                      position: 'absolute',
                      top: '8px',
                      right: '8px',
                      padding: '4px 8px',
                      backgroundColor: 'transparent',
                      border: '1px solid #ddd',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = '#f0f0f0';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = 'transparent';
                    }}
                  >
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                  </button>
                </>
              ) : (
                <span>{msg.content}</span>
              )}
            </div>
                    }}>
                      ğŸŒ Web Search
                    </span>
                  )}
                </div>
              )}
              
              {msg.role === 'ai' ? (
                <ReactMarkdown
                  components={{
                    p: ({node, ...props}) => <p style={{margin: '8px 0'}} {...props} />,
                    ul: ({node, ...props}) => <ul style={{margin: '8px 0', paddingLeft: '20px'}} {...props} />,
                    ol: ({node, ...props}) => <ol style={{margin: '8px 0', paddingLeft: '20px'}} {...props} />,
                    li: ({node, ...props}) => <li style={{margin: '4px 0'}} {...props} />,
                    h1: ({node, ...props}) => <h1 style={{fontSize: '1.5em', margin: '10px 0'}} {...props} />,
                    h2: ({node, ...props}) => <h2 style={{fontSize: '1.3em', margin: '10px 0'}} {...props} />,
                    h3: ({node, ...props}) => <h3 style={{fontSize: '1.1em', margin: '8px 0'}} {...props} />,
                    strong: ({node, ...props}) => <strong style={{fontWeight: 'bold'}} {...props} />,
                    code: ({node, inline, ...props}) => 
                      inline ? 
                        <code style={{backgroundColor: '#f0f0f0', padding: '2px 4px', borderRadius: '3px', fontSize: '0.9em'}} {...props} /> :
                        <code style={{display: 'block', backgroundColor: '#f0f0f0', padding: '10px', borderRadius: '5px', fontSize: '0.9em', overflowX: 'auto'}} {...props} />
                  }}
                >
                  {msg.content}
                </ReactMarkdown>
              ) : (
                <span>{msg.content}</span>
              )}
            </div>
          </div>
        ))}
        
        {loading && (
          <div style={{ textAlign: 'left', margin: '10px 0' }}>
            <span style={{
              display: 'inline-block',
              padding: '10px 15px',
              borderRadius: '12px',
              backgroundColor: '#fff',
              border: '1px solid #e0e0e0',
              color: '#666'
            }}>
              <span className="typing-indicator">â—â—â—</span> Thinking...
            </span>
          </div>
        )}
        
        <div ref={messagesEndRef} />
      </div>

      <div style={{ marginTop: '15px', display: 'flex', gap: '10px', alignItems: 'flex-end' }}>
        <textarea
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={handleKeyPress}
          placeholder="Ask about animal diseases, treatments, symptoms... (Press Enter to send, Shift+Enter for new line)"
          disabled={loading}
          style={{ 
            width: '100%',
            padding: '12px',
            borderRadius: '8px',
            border: '1px solid #ccc',
            resize: 'vertical',
            minHeight: '50px',
            maxHeight: '150px',
            fontSize: '14px',
            fontFamily: 'inherit'
          }}
          rows="2"
        />
        {loading ? (
          <button 
            onClick={stopGeneration}
            style={{
              padding: '12px 20px',
              borderRadius: '8px',
              border: 'none',
              backgroundColor: '#f44336',
              color: 'white',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: 'bold',
              minWidth: '80px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '6px',
              transition: 'background-color 0.3s'
            }}
            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#d32f2f'}
            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f44336'}
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <rect width="24" height="24" rx="2"/>
            </svg>
            Stop
          </button>
        ) : (
          <button 
            onClick={handleSend} 
            disabled={!input.trim()}
            style={{
              padding: '12px 24px',
              borderRadius: '8px',
              border: 'none',
              backgroundColor: !input.trim() ? '#ccc' : '#4CAF50',
              color: 'white',
              cursor: !input.trim() ? 'not-allowed' : 'pointer',
              fontSize: '14px',
              fontWeight: 'bold',
              minWidth: '80px',
              transition: 'background-color 0.3s'
            }}
            onMouseEnter={(e) => {
              if (input.trim()) e.currentTarget.style.backgroundColor = '#45a049';
            }}
            onMouseLeave={(e) => {
              if (input.trim()) e.currentTarget.style.backgroundColor = '#4CAF50';
            }}
          >
            Send
          </button>
        )}
      </div>
      
      <style>{`
        @keyframes blink {
          0%, 20% { opacity: 1; }
          50% { opacity: 0.3; }
          100% { opacity: 1; }
        }
        .typing-indicator {
          animation: blink 1.4s infinite;
        }
      `}</style>
    </div>
  );
}
